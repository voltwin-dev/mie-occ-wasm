name: Release MIE OCC WASM

on:
  workflow_dispatch:
    inputs:
      bump:
        description: "Version bump type (major, minor, patch)"
        required: true
        default: patch
        type: choice
        options:
          - major
          - minor
          - patch

permissions:
  contents: write # push merge commit, push tags, create GitHub Release

concurrency:
  group: mie-occ-wasm-release-${{ github.ref }}
  cancel-in-progress: false

env:
  EM_VERSION: "4.0.15"

jobs:
  release:
    runs-on: ubuntu-latest
    env:
      DEV_BRANCH: ${{ github.ref_name }}
      MAIN_BRANCH: main
    steps:
      - name: Validate branch
        run: |
          if [ "${DEV_BRANCH}" = "${MAIN_BRANCH}" ]; then
            echo "This workflow must be run from a dev branch, not '${MAIN_BRANCH}'."
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: npm

      - name: Configure git identity
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install deps
        run: npm ci

      - name: Bump version on dev branch (commit + push)
        id: bump
        run: |
          set -euo pipefail

          npm version "${{ inputs.bump }}" --no-git-tag-version

          VERSION="$(node -p "require('./package.json').version")"
          TAG="v${VERSION}"

          git add package.json package-lock.json
          git commit -m "Bump version to ${TAG}"
          git push origin ${DEV_BRANCH}

          echo "version=${VERSION}" >> "${GITHUB_OUTPUT}"
          echo "tag=${TAG}" >> "${GITHUB_OUTPUT}"
          echo "bump_sha=$(git rev-parse HEAD)" >> "${GITHUB_OUTPUT}"

      - name: Install build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build

      - name: Setup emsdk + occt
        run: npm run setup
        
      - name: Restore Emscripten cache
        uses: actions/cache@v5
        with:
          path: build/target
          key: emcache-${{ env.EM_VERSION }}-${{ runner.os }}-${{ runner.arch }}
          restore-keys: |
            emcache-${{ env.EM_VERSION }}-${{ runner.os }}-

      - name: Build
        run: npm run build

      - name: Archive build/target
        id: archive
        run: |
          set -euo pipefail
          VERSION="${{ steps.bump.outputs.version }}"
          ARCHIVE="mie-occ-wasm@${VERSION}.tar.gz"
          tar -czf "${ARCHIVE}" -C ../src occ_wasm
          echo "archive=${ARCHIVE}" >> "${GITHUB_OUTPUT}"

      - name: Merge dev into main + tag
        id: merge
        if: ${{ success() }}
        run: |
          set -euo pipefail
          TAG="${{ steps.bump.outputs.tag }}"

          git fetch origin
          git checkout "${MAIN_BRANCH}"
          git pull --ff-only origin "${MAIN_BRANCH}"
          git merge --no-ff "${DEV_BRANCH}" -m "chore(release): merge ${DEV_BRANCH} for ${TAG}"
          git tag "${TAG}"

          git push origin "${MAIN_BRANCH}"
          git push origin "${TAG}"

          echo "merged=true" >> "${GITHUB_OUTPUT}"

      - name: Create GitHub Release + upload artifact
        id: release
        if: ${{ success() }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          TAG="${{ steps.bump.outputs.tag }}"
          ARCHIVE="${{ steps.archive.outputs.archive }}"

          gh release create "${TAG}" "${ARCHIVE}" \
            --title "${TAG}" \
            --generate-notes

          echo "released=true" >> "${GITHUB_OUTPUT}"

      - name: Revert version bump commit on failure
        if: ${{ always() && failure() }}
        run: |
          set -euo pipefail

          if [ "${{ steps.merge.outputs.merged }}" = "true" ]; then
            echo "Main merge already happened; skipping dev bump revert."
            exit 0
          fi

          BUMP_SHA="${{ steps.bump.outputs.bump_sha }}"
          if [ -z "${BUMP_SHA}" ]; then
            echo "No bump commit SHA recorded; nothing to revert."
            exit 0
          fi

          git fetch origin
          git checkout "${DEV_BRANCH}"
          git pull --ff-only origin "${DEV_BRANCH}"

          git revert --no-edit "${BUMP_SHA}"
          git push origin "${DEV_BRANCH}"
